<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>graduated</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js"></script>
<script src="d3.js"></script>

<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
	var cats = ["Series_Complete_Pop_Pct","Booster_Doses_Vax_Pct"]
	
	var colors = {"_30-":"#2f7264",
				"30-40":"#6fa194",
				"40-50": "#b3d0c7",
				"50-60": "#efdbcb",
				"60-70": "#dba788",
				"70+":"#c77560"}
	
	Promise.all([d3.csv("COVID-19_Vaccinations_in_the_United_States_County (1).csv"),d3.json("dots.geojson")])
	.then(function(data){
		console.log(data)
		var dots = data[1]
		var vaccines = data[0]
		
		var vaccineDictionary = vaccineByFIPS(vaccines)
		console.log(vaccineDictionary)
		var joinedData = joinRatesToDots(dots,vaccineDictionary)
		console.log(joinedData)
		
		drawMap(joinedData)
	})
	
	function vaccineByFIPS(vaccines){
		var formatted = {}
		for(var v in vaccines){
			var fips = "_"+vaccines[v].FIPS
			var entry = vaccines[v]
			formatted[fips]=entry
		}
		return formatted
	}
	
	function joinRatesToDots(dots,vaccines){
		var newFeatures = []
		for(var d in dots.features){
			//console.log(dots.features[d])
			var fips = "_"+dots.features[d].properties.GEOID
			//console.log(fips)
			var newFeature = dots.features[d]
			var vaccineData = vaccines[fips]
			if(vaccineData!=undefined){
				for(var c in cats){
					var cat = cats[c]
					//console.log(cat)
					//console.log(vaccineData[cat])
				
						newFeature.properties[cat]=parseFloat(vaccineData[cat])
					}
				}// else{
// 					//console.log(fips)
// 				}
			
			//break
			newFeatures.push(newFeature)
		}
		dots.features = newFeatures
		return dots
	}
	
	
	function drawMap(data){
		mapboxgl.accessToken = 'pk.eyJ1IjoiYzRzci1nc2FwcCIsImEiOiJja2J0ajRtNzMwOHBnMnNvNnM3Ymw5MnJzIn0.fsTNczOFZG8Ik3EtO9LdNQ';
	    const map = new mapboxgl.Map({
	        container: 'map', // container ID
	        style: 'mapbox://styles/c4sr-gsapp/cl25fr4wl001i15qnxmelv27v', // custom style url from https://studio.mapbox.com/
	        center: [-95.651,39.646], // starting position
	        zoom: 4 // starting zoom
	    });
		map.on("load",function(){
		
   		map.addSource('dots', {
   		'type': 'geojson',
   		'data': data
   		})
	
	
   			// 	    var matchString = {
   			// 	    property: "tally_percentile",
   			// 	    stops: [
   			// [0,"green"],
   			// [.5,"yellow"],
   			// [1,"red"]
   			// ]
   			// 	    }
			var opacityScale = {
		 	    property: "DN",
		 	    stops: [
					 [0,0],
					 [1,.2],
					 [50,.6],
					[8000,1]
					 ]
			}
 	    var radiusScale = {
 	    property: "DN",
 	    stops: [
			 [0,0],
			 [10,2],
			 [50,6],
			[8000,8]
			 ]
			 	    }
	 
					var colorScale={
						property:cats[0],
						stops:[
							[0,"#c77560"],
 							[30, "#dba788"],
 							[40, "#efdbcb"],
 							[50,"#b3d0c7"],
							[60,"#6fa194"],
							[70,"#2f7264"],
							
							
						]
					}
   		 map.addLayer({
   		'id': "countiesFill",
   		'type': 'circle',
   		'source': 'dots', // reference the data source
   		'layout': {
   			
   		},
   		'paint': {
			"circle-opacity":opacityScale,
			'circle-radius':6,//radiusScale,
			"circle-color":colorScale
   		}
   		});
		
		})
	}
	
	
	
</script>

</body>
</html>